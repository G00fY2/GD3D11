name: 'Package artifacts'

inputs:
  nightly:
    description: "Boolean string ('true'/'false')"
    required: true
  artifact-name:
    description: "Name of the artifact that will be uploaded"
    required: true

runs:
  using: composite
  steps:
    - name: Calculate artifact path name
      id: calc-path
      shell: pwsh
      run: |
        if ("${{ inputs.nightly }}" -eq "true") {
          $shortHash = $env:GITHUB_SHA.Substring(0, 9)
          $dirName = "GD3D11-git-$shortHash"
        } else {
          $rawName = $env:GITHUB_REF -replace '^refs/(tags|heads)/', ''
          $safeName = $rawName -replace '/', '-'
          $dirName = "GD3D11-$safeName"
        }

        "release_dir=$dirName" >> $env:GITHUB_OUTPUT
        "download_dir=downloaded-artifacts" >> $env:GITHUB_OUTPUT

    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        path: ${{ steps.calc-path.outputs.download_dir }}
        merge-multiple: true

    - name: Prepare Release Structure
      shell: pwsh
      run: |
        $relDir = "${{ steps.calc-path.outputs.release_dir }}"
        $artifactDir = ${{ steps.calc-path.outputs.download_dir }}
        $binDir = "$relDir/GD3D11/Bin"

        New-Item -Path $binDir -ItemType Directory -Force
        
        Copy-Item -Path "D3D11Engine/Shaders/*" -Destination "$relDir/GD3D11/shaders/" -Recurse -Force
        Copy-Item -Path "blobs/Fonts" -Destination "$relDir/GD3D11/Fonts/" -Recurse -Force
        Copy-Item -Path "blobs/Meshes" -Destination "$relDir/GD3D11/Meshes/" -Recurse -Force
        Copy-Item -Path "blobs/Textures" -Destination "$relDir/GD3D11/Textures/" -Recurse -Force
        Copy-Item -Path "blobs/libs/*" -Destination "$relDir/" -Recurse -Force
        Copy-Item -Path "blobs/bin/wine-d2d1.dll" -Destination "$relDir/GD3D11/Bin/d2d1.dll" -Force

        Copy-Item -Path "$artifactDir/*" -Destination $binDir -Force
        Move-Item -Path "$binDir/ddraw.dll" -Destination "$relDir/" -Force

    - name: Create final Zip
      shell: pwsh
      run: |
        $relDir = "${{ steps.path.outputs.release_dir }}"
        7z a -tzip "$relDir.zip" "./$relDir/*"

    - name: Upload Zip artifact
      uses: actions/upload-artifact@v6
      with:
        name: ${{ inputs.artifact-name }}
        path: "*.zip"
        compression-level: 0
        retention-days: 2
